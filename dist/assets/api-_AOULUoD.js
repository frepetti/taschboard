import{s as p}from"./index-BvDo0rdQ.js";const y="https://afatvrttubtzjdjzrsfy.supabase.co",l="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFmYXR2cnR0dWJ0empkanpyc2Z5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3OTkyMjYsImV4cCI6MjA4MzM3NTIyNn0.k6ZPthfvILsIJX7DLBZJI0Ge8ne6scGCmD036KrwbhA",m=`${y}/functions/v1/make-server-364126c3`;async function n(r,s={},o){const c={"Content-Type":"application/json",apikey:l,Authorization:`Bearer ${o||l}`,...s.headers},a=`${m}${r}`;console.log("ğŸŒ API Request to Server:",{url:a,method:s.method||"GET"});try{let e=await fetch(a,{...s,headers:c});if(console.log("ğŸ“¡ Server Response status:",e.status),e.status===401){console.warn("ğŸ”„ 401 Unauthorized detected, attempting token refresh...");try{const{data:{session:t},error:u}=await p.auth.refreshSession();if(u||!t?.access_token)throw console.error("âŒ Failed to refresh session:",u),new Error("Unauthorized: Session expired. Please login again.");console.log("âœ… Session refreshed successfully, retrying request...");const f={...c,Authorization:`Bearer ${t.access_token}`};if(e=await fetch(a,{...s,headers:f}),console.log("ğŸ“¡ Retry Response status:",e.status),e.status===401){let d="";try{const h=await e.clone().json();d=JSON.stringify(h)}catch{d=await e.clone().text()}throw console.error("âŒ Server rejected refreshed token (likely misconfigured secrets):",d),new Error(`Server Forbidden: Token rejected after refresh. Check Edge Function secrets. Details: ${d}`)}}catch(t){throw t.message?.includes("Server Forbidden")||(console.error("ğŸš« Auth refresh failed:",t),typeof window<"u"&&(console.log("ğŸ“¢ Dispatching auth:unauthorized event"),window.dispatchEvent(new Event("auth:unauthorized")))),t}}let i;if(e.headers.get("content-type")?.includes("application/json"))i=await e.json();else{const t=await e.text();if(!e.ok)throw console.error("âŒ Non-JSON response:",t),new Error(`Server returned non-JSON response: ${t.substring(0,100)}`);i={success:!0,message:t}}if(!e.ok)throw console.error("âŒ API error response:",i),new Error(i.error||`API request failed with status ${e.status}`);return console.log("âœ… API request successful"),i}catch(e){throw console.error("âŒ API request error:",e),e.message?.includes("Failed to fetch")?new Error("Error de red o servidor no disponible (CORS/503). Verifica los logs de Supabase."):e}}const I={signup:async(r,s,o,c="inspector",a)=>n("/auth/signup",{method:"POST",body:JSON.stringify({email:r,password:s,name:o,role:c,company:a})})},S={getUsers:async r=>n("/admin/users",{method:"GET"},r),updateUser:async(r,s,o)=>n(`/admin/users/${r}`,{method:"PATCH",body:JSON.stringify(s)},o),deleteUser:async(r,s)=>n(`/admin/users/${r}`,{method:"DELETE"},s),getAllTickets:async r=>n("/admin/tickets",{method:"GET"},r),updateTicket:async(r,s,o)=>n(`/admin/tickets/${r}`,{method:"PATCH",body:JSON.stringify(s)},o),getStats:async r=>n("/admin/stats",{method:"GET"},r)};export{I as a,S as b};
